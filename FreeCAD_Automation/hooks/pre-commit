#!/bin/bash
echo "DEBUG: pre-commit hook trap-card triggered!" >&2
# ==============================================================================================
#                                 Verify and Retrieve Dependencies
# ==============================================================================================
# Import code used in this script
FUNCTIONS_FILE="FreeCAD_Automation/utils.sh"
source "$FUNCTIONS_FILE"

# ==============================================================================================
#                         Check if user allowed to modify .FCStd files
# ==============================================================================================
if [ "$REQUIRE_LOCKS" == "$TRUE" ]; then
    CURRENT_USER=$(git config --get user.name) || {
        echo "Error: git config user.name not set!" >&2
        exit $FAIL
    }

    CURRENT_LOCKS=$(git lfs locks | awk '$2 == "'$CURRENT_USER'" {print $1}') || {
        echo "Error: failed to list of active lock info." >&2
        exit $FAIL
    }

    # Get staged `.FCStd` files
    # Diff Filter => (A)dded / (C)opied / (D)eleted / (M)odified / (R)enamed / (T)ype changed / (U)nmerged / (X) unknown / (B)roken pairing
    STAGED_FCSTD_FILES=$(git diff-index --cached --name-only --diff-filter=CDMRTUXB HEAD | grep -i '\.fcstd$')
    echo -e "\nDEBUG: checking staged FCStd files: '$(echo $STAGED_FCSTD_FILES | xargs)'" >&2

    for FCStd_file_path in $STAGED_FCSTD_FILES; do
        echo -e "\nDEBUG: checking '$FCStd_file_path'...." >&2

        if [ -s "$FCStd_file_path" ]; then
            echo "ERROR: $FCStd_file_path is not empty, export it using \`git fadd\` or clear it using \`git fcmod\`" >&2
            exit $FAIL
        fi
    done

    # Get staged `.changefile`s
    # Diff Filter => (A)dded / (C)opied / (D)eleted / (M)odified / (R)enamed / (T)ype changed / (U)nmerged / (X) unknown / (B)roken pairing
    STAGED_CHANGEFILES=$(git diff-index --cached --name-only --diff-filter=CDMRTUXB HEAD | grep -i '\.changefile$')
    echo -e "\nDEBUG: checking staged changefiles: '$(echo $STAGED_CHANGEFILES | xargs)'" >&2

    for changefile in $STAGED_CHANGEFILES; do
        echo -e "\nDEBUG: checking '$changefile'....$(grep 'File Last Exported On:' "$changefile")" >&2

        FCStd_dir_path=$(dirname $changefile)
        lockfile="$FCStd_dir_path/.lockfile"

        if echo "$CURRENT_LOCKS" | grep -q "$lockfile"; then
            echo "DEBUG: valid lock found for '$lockfile'" >&2
            :
        else
            echo "ERROR: User doesn't have lock for '$lockfile'... Aborting commit operation..." >&2
            exit $FAIL
        fi
    done
fi

exit $SUCCESS